<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign2Talk - Tradutor de Libras</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
    <style>
        /* =========================================== */
        /* ESTILOS DE LAYOUT (Baseado na imagem de referência) */
        /* =========================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(to top, #4e4d6d, #6f6da6, #6f6da6);
            color: #eceff1;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center; 
            min-height: 100vh;
        }

        nav {
            width: 100%;
            background-color: #181740; 
            padding: 10px 20px;
            box-sizing: border-box; 
        }

        .innav {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        .innav img { height: 28px; } /* Ajuste o tamanho dos ícones/logo */

        .container {
            display: flex;
            justify-content: center;
            align-items: center; 
            padding: 20px;
            width: 100%;
            max-width: 1200px; 
            box-sizing: border-box;
            flex-grow: 1; /* Permite que o container cresça para centralizar verticalmente */
        }

        .both {
            display: flex;
            flex-direction: row; 
            gap: 30px; 
            justify-content: center;
            flex-wrap: wrap; 
        }

        .imageout {
            width: 640px; 
            height: 480px; 
            background: #000000; 
            border-radius: 10px;
            overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        /* Ajuste para fazer o vídeo preencher o quadrado preto */
        .imageout video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Espelha a imagem da webcam */
        }
        
        .textout {
            width: 300px; 
            display: flex;
            flex-direction: column;
            gap: 15px; 
        }

        /* Área dos Resultados e Controles */
        .innertext {
            background: #181740;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .results-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
        }

        #resultado {
            font-size: 2em;
            font-weight: bold;
            margin: 5px 0;
            min-height: 35px;
        }

        .confidence {
            font-size: 1em;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        /* Imagem do Gesto do BD */
        #imagemGesto {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-top: 10px;
            border-radius: 4px;
        }

        /* Botoes Iniciar */
        .buttonscontainer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .button, .button2 {
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            background: #181740;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .button:hover, .button2:hover { background: #06063b; }
        .button2 img { height: 20px; }

        /* Treinamento */
        .training-section {
            margin-top: 15px;
        }

        .letters-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 Colunas para parecer com a imagem */
            gap: 5px;
            margin: 10px 0;
        }

        .btn-letter {
            background: #3e3e58;
            color: white;
            padding: 6px 3px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-letter:hover { background: #5c5c7d; }
        .btn-letter:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Controles (Detecção, Treinar, Reconhecer) */
        .control-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
        }
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-primary { background: #007bff; }
        .btn-stop { background: #95a5a6; }
        .btn-save { background: #f39c12; }
        .btn-load { background: #1abc9c; }
        .btn-clear { background: #e67e22; }

        /* Status */
        .status-info {
            background: #181740; 
            padding: 8px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 12px;
            color: #eceff1; 
            border-left: 3px solid #007bff;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <nav>
        <div class="innav">
            <img src="Group 1.svg" alt="Logo">
            <img src="account_circle.svg" alt="Conta">
        </div>
    </nav>
    <div class="container">
        <div class="both">
            <div class="imageout">
                <video id="webcam" autoplay playsinline></video>
                <canvas id="handCanvas" style="display: none;"></canvas> </div> 
            
            <div class="textout">
                <div class="innertext">
                    <p id="statusText" style="margin-bottom: 10px;">IA carregada! Clique em 'Iniciar'.</p>
                    
                    <div class="results-box">
                        Sinal Reconhecido:
                        <div id="resultado">---</div>
                        <div class="confidence" id="confianca">Confiança: 0%</div>
                        <img id="imagemGesto" style="display: none;" alt="Gesto em Libras">
                    </div>

                    <div class="buttonscontainer">
                        <button class="button2">
                            <img src="image 21.svg" alt="Bandeira">
                        </button>
                        <button class="button" id="play" onclick="initWebcam()">
                            Iniciar
                        </button>
                        <button class="button2">
                            <img src="Rectangle 92.svg" alt="Virar Câmera">
                        </button>
                    </div>

                    <div class="training-section">
                        Treinar Letras:
                        <div class="letters-grid" id="lettersGrid">
                            </div>
                    </div>

                    <div class="control-buttons">
                        <button class="btn btn-primary" id="captureBtn" onclick="trainLetterWrapper()" disabled>
                            Treinar
                        </button>
                        <button class="btn btn-success" id="recognizeBtn" onclick="startRecognition()" disabled>
                            Reconhecer
                        </button>
                        <button class="btn btn-danger" id="stopBtn" onclick="stopRecognition()" disabled>
                            Parar
                        </button>
                        <button class="btn btn-warning" id="saveBtn" onclick="saveModel()" disabled>
                            Salvar
                        </button>
                        <button class="btn btn-load" id="loadBtn" onclick="loadModel()">
                            Carregar
                        </button>
                    </div>

                    <div class="status-info">
                        Status: <span id="status">Aguardando inicialização...</span>
                    </div>

                </div>
            </div>
        </div>
    </div> 
    
    <script>
        // ===================================================================
        // JAVASCRIPT COMPLETO (INTEGRAÇÃO BD/RENDER)
        // ===================================================================
        
        const RENDER_API_URL = 'https://sign2talk.onrender.com'; // Sua URL pública
        
        let modeloMobileNet;
        let classificador;
        let webcam;
        let reconhecendo = false;
        let animationFrameId = null;
        
        // ===================================================================
        // FUNÇÕES DE UTILIDADE E CONTROLE
        // ===================================================================

        function atualizarStatus(mensagem) {
            const statusElem = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            if (statusElem) statusElem.textContent = mensagem;
            if (statusText) statusText.textContent = `IA carregada! Clique em 'Iniciar'.`; // Mantém a mensagem principal como na imagem
        }
        
        function criarBotoesLetras() {
            const grid = document.getElementById('lettersGrid');
            const letras = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let letra of letras) {
                const btn = document.createElement('button');
                btn.className = 'btn-letter';
                btn.id = 'train' + letra;
                btn.textContent = letra;
                // O treinamento agora é feito pelo wrapper que pega a letra clicada
                btn.onclick = () => trainLetter(letra);
                btn.disabled = true;
                grid.appendChild(btn);
            }
        }
        
        function habilitarControles() {
            const buttons = ['recognizeBtn', 'stopBtn', 'saveBtn', 'loadBtn', 'captureBtn']; // captureBtn é o novo botão Treinar
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = false;
            });
            const letras = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let letra of letras) {
                const btn = document.getElementById('train' + letra);
                if (btn) btn.disabled = false;
            }
        }
        
        // Função Wrapper para Treinar (o botão principal 'Treinar' não é mais para uma letra específica)
        // O treinamento será disparado ao clicar no botão de letra. Este botão apenas habilita o treino.
        function trainLetterWrapper() {
             atualizarStatus("Pronto para treinar! Clique em uma das letras A-Z.");
        }
        
        // Função auxiliar para atualizar as estatísticas de amostras
        function atualizarContadorAmostras() {
            // (Esta função é complexa, se ela estava no app.js, adicione-a aqui, ou mantenha-a simples)
            // Lógica para contar amostras no classificador
        }

        // ===================================================================
        // FUNÇÕES DE IA E LÓGICA DO PROJETO (Base do app.js)
        // ===================================================================

        async function inicializarSistema() {
            try {
                atualizarStatus("Carregando modelo de IA...");
                modeloMobileNet = await mobilenet.load();
                classificador = knnClassifier.create();
                criarBotoesLetras(); // Cria os botões A-Z
                atualizarStatus("IA carregada! Clique em 'Iniciar'.");
            } catch (error) {
                console.error("Erro na inicialização:", error);
                atualizarStatus("Erro ao carregar IA.");
            }
        }
        
        async function initWebcam() {
            const playBtn = document.getElementById('play');
            try {
                // ... (Lógica da câmera)
                webcam = document.getElementById('webcam');
                // ... (restante da lógica de permissão, stream, e play)
                
                // MOCK DE CÂMERA (Substitua por sua lógica real de webcam)
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcam.srcObject = stream;
                await webcam.play();
                
                habilitarControles();
                playBtn.textContent = 'Iniciado';
                atualizarStatus("Câmera conectada!");
            } catch (error) {
                playBtn.textContent = 'Iniciar';
                atualizarStatus("Erro na câmera.");
            }
        }
        
        // A função trainLetter foi mantida (ela é chamada quando clicamos nas letras A-Z)
        async function trainLetter(letra) {
             // ... (Sua lógica de treino por webcam, usando webcam, modeloMobileNet, etc.)
             if (!webcam || !modeloMobileNet || !classificador) return;
             // Lógica para capturar e adicionar amostra...
             atualizarStatus(`${letra} treinada!`); // MOCK
        }


        // ========== INTEGRAÇÃO COM BANCO DE DADOS (RENDER) ==========
        async function buscarGestoDoBD(letraReconhecida, confianca) {
            const palavraChave = letraReconhecida.toUpperCase(); 
            try {
                const response = await fetch(`${RENDER_API_URL}/api/vocabulario/${palavraChave}`); 
                if (response.status === 404) {
                    atualizarResultado(letraReconhecida, confianca, null); 
                    return;
                }
                const dadosGesto = await response.json();
                atualizarResultado(dadosGesto.palavra || letraReconhecida, confianca, dadosGesto.url_imagem); 
            } catch (error) {
                 atualizarResultado(letraReconhecida, confianca, null);
            }
        }
        
        // ========== RECONHECIMENTO (COM INTEGRAÇÃO BD) ==========
        async function startRecognition() {
            // ... (Sua lógica de startRecognition() que chama buscarGestoDoBD)
            
            // MOCK: Apenas para simular a chamada API
             if (!classificador) return;
             reconhecendo = true;
             while(reconhecendo) {
                 // Simula a predição da IA e chama a API
                 await buscarGestoDoBD('A', 85); 
                 await new Promise(r => setTimeout(r, 500)); 
                 if (!reconhecendo) break;
             }
        }

        function stopRecognition() {
            reconhecendo = false;
            atualizarStatus("Reconhecimento parado");
        }
        
        // ========== ATUALIZAÇÃO DA INTERFACE COM IMAGEM BD ==========
        function atualizarResultado(letraOuPalavra, confianca, urlImagem) { 
            const resultadoElem = document.getElementById('resultado');
            const confiancaElem = document.getElementById('confianca');
            const imagemGesto = document.getElementById('imagemGesto'); 

            if (resultadoElem && confiancaElem) {
                resultadoElem.textContent = letraOuPalavra;
                confiancaElem.textContent = `Confiança: ${confianca.toFixed(1)}%`;
                
                // Lógica de cor (Mantenha a cor da sua versão original)
                // const cor = ...
                
                if (imagemGesto) {
                    if (urlImagem) {
                        imagemGesto.src = `${RENDER_API_URL}${urlImagem}`; 
                        imagemGesto.style.display = 'block';
                    } else {
                        imagemGesto.style.display = 'none';
                    }
                }
            }
        }
        
        // MOCK das funções loadModel/saveModel para evitar erro (você deve inserir o código real)
        async function loadModel() { atualizarStatus("Carregando modelo do Render."); }
        async function saveModel() { atualizarStatus("Salvando modelo no Render."); }
        
        // ========== INICIALIZAÇÃO ==========
        document.addEventListener('DOMContentLoaded', function() {
            inicializarSistema();
            
            document.getElementById('play').addEventListener('click', function() {
                initWebcam();
            });
        });
    </script>
</body>
</html>
